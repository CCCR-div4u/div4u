name: Kubernetes Security Analysis

# íŠ¸ë¦¬ê±° ì¡°ê±´ (Requirements 1.2, 1.3, 6.2, 6.4)
on:
  push:
    branches: [main, develop]
    paths:
      - 'k8s-test-scenario/**'
  pull_request:
    paths:
      - 'k8s-test-scenario/**'
  workflow_dispatch:
    inputs:
      reason:
        description: 'ìˆ˜ë™ ì‹¤í–‰ ì´ìœ '
        required: false
        default: 'ìˆ˜ë™ ë³´ì•ˆ ê²€ì‚¬'
  schedule:
    - cron: '0 2 * * *'  # ë§¤ì¼ ì˜¤ì „ 2ì‹œ (KST 11ì‹œ) ìë™ ì‹¤í–‰

# ìµœì†Œ ê¶Œí•œ ì›ì¹™ (Requirement 5.3)
permissions:
  contents: read
  security-events: write
  issues: write
  pull-requests: write

# ë™ì‹œì„± ì œì–´ - ë™ì¼ ë¸Œëœì¹˜ì—ì„œ ì¤‘ë³µ ì‹¤í–‰ ë°©ì§€ ë° ì„±ëŠ¥ ìµœì í™” (Requirement 6.4)
concurrency:
  group: k8s-security-${{ github.ref }}-${{ github.event_name }}
  cancel-in-progress: ${{ github.event_name != 'schedule' }}

jobs:
  k8s-security-scan:
    runs-on: ubuntu-latest
    
    steps:
      - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ë³€ê²½ì‚¬í•­ ê°ì§€ (ì„±ëŠ¥ ìµœì í™”)
        uses: dorny/paths-filter@v3
        id: changes
        with:
          filters: |
            k8s:
              - 'k8s-test-scenario/**/*.yaml'
              - 'k8s-test-scenario/**/*.yml'
              - 'k8s-test-scenario/**/*.json'
            # ì œì™¸í•  íŒŒì¼ë“¤ (ì„±ëŠ¥ ìµœì í™”)
            exclude:
              - '**/*.md'
              - '**/*.txt'
              - '**/*.log'
              - '.git/**'
              - '.github/**'
              - 'docs/**'
              - 'examples/**'
          # ë³€ê²½ ê°ì§€ ìµœì í™” ì˜µì…˜
          list-files: json
          initial-fetch-depth: 10

      - name: ì‹¤í–‰ ì´ìœ  ì„¤ì •
        id: reason
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "reason=${{ github.event.inputs.reason }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "schedule" ]; then
            echo "reason=ì •ê¸° ìë™ ê²€ì‚¬" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "reason=PR ë³´ì•ˆ ê²€ì‚¬" >> $GITHUB_OUTPUT
          else
            echo "reason=ì½”ë“œ ë³€ê²½ ê°ì§€" >> $GITHUB_OUTPUT
          fi

      - name: Python í™˜ê²½ ì„¤ì • (ìºì‹± ìµœì í™”)
        if: steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        uses: actions/setup-python@v4
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: ë³´ì•ˆ í™˜ê²½ ê²€ì¦ (Requirements 5.2, 5.3, 7.1)
        if: steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        run: |
          echo "ğŸ”’ ë³´ì•ˆ í™˜ê²½ ê²€ì¦ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
          
          # ë³´ì•ˆ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          if [ -f "scripts/security_validation.py" ]; then
            python scripts/security_validation.py
          else
            echo "âš ï¸ ë³´ì•ˆ ê²€ì¦ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ ê²€ì¦ì„ ìˆ˜í–‰í•©ë‹ˆë‹¤."
            
            # ê¸°ë³¸ í™˜ê²½ë³€ìˆ˜ ê²€ì¦
            echo "ğŸ“‹ í•„ìˆ˜ í™˜ê²½ë³€ìˆ˜ í™•ì¸:"
            for var in GITHUB_REPOSITORY GITHUB_REF GITHUB_SHA; do
              if [ -n "${!var}" ]; then
                echo "  âœ… $var: ì„¤ì •ë¨"
              else
                echo "  âŒ $var: ëˆ„ë½"
              fi
            done
            
            echo "ğŸ“‹ ì„ íƒì  í™˜ê²½ë³€ìˆ˜ í™•ì¸:"
            if [ -n "$OPENAI_API_KEY" ]; then
              echo "  âœ… OPENAI_API_KEY: sk-****...****"
            else
              echo "  âš ï¸ OPENAI_API_KEY: ë¯¸ì„¤ì • (Fallback ë¦¬í¬íŠ¸ ì‚¬ìš©)"
            fi
            
            if [ -n "$SLACK_WEBHOOK_URL_CHECKOV" ]; then
              echo "  âœ… SLACK_WEBHOOK_URL_CHECKOV: https://hooks.slack.com/***"
            else
              echo "  âš ï¸ SLACK_WEBHOOK_URL_CHECKOV: ë¯¸ì„¤ì • (ì•Œë¦¼ ê±´ë„ˆëœ€)"
            fi
          fi
          
          echo "âœ… ë³´ì•ˆ í™˜ê²½ ê²€ì¦ ì™„ë£Œ"

      - name: ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸ ë° ìµœì í™”
        if: steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        run: |
          echo "ğŸ’» ì‹œìŠ¤í…œ ë¦¬ì†ŒìŠ¤ í™•ì¸..."
          echo "ğŸ–¥ï¸ CPU ì •ë³´:"
          nproc
          echo "ğŸ§  ë©”ëª¨ë¦¬ ì •ë³´:"
          free -h
          echo "ğŸ’¾ ë””ìŠ¤í¬ ì •ë³´:"
          df -h
          
          # ì„±ëŠ¥ ìµœì í™”ë¥¼ ìœ„í•œ í™˜ê²½ë³€ìˆ˜ ì„¤ì •
          echo "âš¡ ì„±ëŠ¥ ìµœì í™” ì„¤ì •..."
          export PYTHONUNBUFFERED=1
          export CHECKOV_RUNNER_FILTER=true
          export CHECKOV_COMPACT_MODE=true
          
          # CPU ì½”ì–´ ìˆ˜ì— ë”°ë¥¸ ë³‘ë ¬ ì²˜ë¦¬ ì„¤ì •
          CPU_CORES=$(nproc)
          if [ "$CPU_CORES" -gt 2 ]; then
            export CHECKOV_PARALLEL_RUNNERS=$((CPU_CORES - 1))
            echo "ğŸš€ ë³‘ë ¬ ì²˜ë¦¬ ì„¤ì •: ${CHECKOV_PARALLEL_RUNNERS}ê°œ ëŸ¬ë„ˆ"
          fi

      - name: Checkov ì„¤ì¹˜
        if: steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        run: |
          echo "ğŸ”§ Checkov ë° ì˜ì¡´ì„± ì„¤ì¹˜ ì¤‘..."
          
          # pip ì—…ê·¸ë ˆì´ë“œ ë° íŒ¨í‚¤ì§€ ì„¤ì¹˜ (ì¬ì‹œë„ ë¡œì§ í¬í•¨)
          MAX_RETRIES=3
          RETRY_COUNT=0
          
          while [ $RETRY_COUNT -lt $MAX_RETRIES ]; do
            echo "ğŸ“¦ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹œë„ $((RETRY_COUNT + 1))/$MAX_RETRIES"
            
            if pip install --upgrade pip --timeout=60 --retries=3 && \
               pip install checkov requests openai --timeout=60 --retries=3; then
              echo "âœ… íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì„±ê³µ"
              break
            else
              RETRY_COUNT=$((RETRY_COUNT + 1))
              if [ $RETRY_COUNT -lt $MAX_RETRIES ]; then
                echo "âš ï¸ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ì‹¤íŒ¨ - 10ì´ˆ í›„ ì¬ì‹œë„..."
                sleep 10
              else
                echo "âŒ íŒ¨í‚¤ì§€ ì„¤ì¹˜ ìµœì¢… ì‹¤íŒ¨"
                echo "ğŸ” pip ì„¤ì • í™•ì¸:"
                pip config list || true
                echo "ğŸ” Python í™˜ê²½ í™•ì¸:"
                python --version
                pip --version
                exit 1
              fi
            fi
          done
          
          # Checkov ë²„ì „ í™•ì¸
          echo "ğŸ” ì„¤ì¹˜ëœ Checkov ë²„ì „:"
          checkov --version || echo "âš ï¸ Checkov ë²„ì „ í™•ì¸ ì‹¤íŒ¨"

      - name: Kubernetes ë³´ì•ˆ ìŠ¤ìº” ì‹¤í–‰ (Requirements 1.2, 6.2)
        if: steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        run: |
          echo "ğŸ” Kubernetes ë³´ì•ˆ ìŠ¤ìº”ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
          echo "ğŸ“ ìŠ¤ìº” ëŒ€ìƒ: k8s-test-scenario ë””ë ‰í„°ë¦¬"
          
          # ë””ë ‰í„°ë¦¬ ì¡´ì¬ í™•ì¸ (Requirement 7.1)
          if [ ! -d "k8s-test-scenario" ]; then
            echo "âŒ k8s-test-scenario ë””ë ‰í„°ë¦¬ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
            echo "ğŸ“ í˜„ì¬ ë””ë ‰í„°ë¦¬ êµ¬ì¡°:"
            ls -la
            echo "ğŸ”§ ê¸°ë³¸ í…ŒìŠ¤íŠ¸ ë””ë ‰í„°ë¦¬ë¥¼ ìƒì„±í•©ë‹ˆë‹¤..."
            mkdir -p k8s-test-scenario
            echo "âš ï¸ ìŠ¤ìº”í•  íŒŒì¼ì´ ì—†ìœ¼ë¯€ë¡œ ê¸°ë³¸ ê²°ê³¼ë¥¼ ìƒì„±í•©ë‹ˆë‹¤."
          fi
          
          # ì„±ëŠ¥ ìµœì í™”: ë³€ê²½ëœ íŒŒì¼ë§Œ ìš°ì„  ìŠ¤ìº”
          CHANGED_FILES=""
          if [ "${{ github.event_name }}" = "pull_request" ] && [ -n "${{ steps.changes.outputs.k8s_files }}" ]; then
            CHANGED_FILES="${{ steps.changes.outputs.k8s_files }}"
            echo "ğŸ“‹ ë³€ê²½ëœ íŒŒì¼ ìš°ì„  ìŠ¤ìº”: $(echo "$CHANGED_FILES" | jq length)ê°œ"
            echo "$CHANGED_FILES" | jq -r '.[]' | head -10
          fi
          
          # ìŠ¤ìº” ëŒ€ìƒ íŒŒì¼ í™•ì¸
          YAML_FILES=$(find k8s-test-scenario -type f \( -name "*.yaml" -o -name "*.yml" \) 2>/dev/null | wc -l)
          JSON_FILES=$(find k8s-test-scenario -type f -name "*.json" 2>/dev/null | wc -l)
          TOTAL_FILES=$((YAML_FILES + JSON_FILES))
          echo "ğŸ“‹ ë°œê²¬ëœ íŒŒì¼: YAML ${YAML_FILES}ê°œ, JSON ${JSON_FILES}ê°œ (ì´ ${TOTAL_FILES}ê°œ)"
          
          # ëŒ€ìš©ëŸ‰ íŒŒì¼ í™•ì¸ ë° ê²½ê³  (5MB ì´ìƒ)
          echo "ğŸ” ëŒ€ìš©ëŸ‰ íŒŒì¼ ê²€ì‚¬..."
          LARGE_FILES=$(find k8s-test-scenario -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.json" \) | xargs ls -la 2>/dev/null | awk '$5 > 5242880 {print $9, $5}' || true)
          if [ -n "$LARGE_FILES" ]; then
            echo "âš ï¸ ëŒ€ìš©ëŸ‰ íŒŒì¼ ë°œê²¬ (5MB ì´ìƒ):"
            echo "$LARGE_FILES"
            echo "ğŸ’¡ ìŠ¤ìº” ì‹œê°„ì´ ì˜¤ë˜ ê±¸ë¦´ ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          fi
          
          if [ "$TOTAL_FILES" -gt 0 ]; then
            echo "ğŸ“‹ ìŠ¤ìº” ëŒ€ìƒ íŒŒì¼ ëª©ë¡ (ìµœëŒ€ 10ê°œ):"
            find k8s-test-scenario -type f \( -name "*.yaml" -o -name "*.yml" -o -name "*.json" \) | head -10
          else
            echo "âš ï¸ ìŠ¤ìº”í•  íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤."
          fi
          
          # Checkov ì‹¤í–‰ í•¨ìˆ˜ ì •ì˜ (ì„±ëŠ¥ ìµœì í™” ë° ì—ëŸ¬ í•¸ë“¤ë§ - Requirement 7.1, 7.2)
          run_checkov() {
            local output_format="$1"
            local output_file="$2"
            local max_retries=2
            local retry_count=0
            
            # ê¸°ì¡´ íŒŒì¼/ë””ë ‰í„°ë¦¬ ì •ë¦¬
            if [ -e "$output_file" ]; then
              rm -rf "$output_file"
            fi
            
            # ì„±ëŠ¥ ìµœì í™” ì˜µì…˜ ì„¤ì •
            local checkov_args=(
              --directory k8s-test-scenario
              --framework kubernetes
              --output "$output_format"
              --quiet
              --compact
              --soft-fail
            )
            
            # ëŒ€ìš©ëŸ‰ íŒŒì¼ì´ ìˆëŠ” ê²½ìš° ì¶”ê°€ ìµœì í™”
            if [ -n "$LARGE_FILES" ]; then
              checkov_args+=(--timeout 180)  # 3ë¶„ íƒ€ì„ì•„ì›ƒ
              echo "âš¡ ëŒ€ìš©ëŸ‰ íŒŒì¼ ê°ì§€ - íƒ€ì„ì•„ì›ƒ ì„¤ì •: 180ì´ˆ"
            fi
            
            # íŒŒì¼ ìˆ˜ê°€ ë§ì€ ê²½ìš° ë°°ì¹˜ ì²˜ë¦¬
            if [ "$TOTAL_FILES" -gt 100 ]; then
              checkov_args+=(--use-enforcement-rules)
              echo "âš¡ ë‹¤ìˆ˜ íŒŒì¼ ê°ì§€ - ë°°ì¹˜ ì²˜ë¦¬ ëª¨ë“œ í™œì„±í™”"
            fi
            
            # ì„±ëŠ¥ ìµœì í™” ì˜µì…˜ì— --output-file ì¶”ê°€
            checkov_args+=(--output-file "$output_file")
            
            while [ $retry_count -lt $max_retries ]; do
              echo "ğŸ” Checkov ì‹¤í–‰ ($output_format í˜•ì‹, ì‹œë„ $((retry_count + 1))/$max_retries)"
              echo "âš¡ ì„±ëŠ¥ ìµœì í™” ì˜µì…˜: íƒ€ì„ì•„ì›ƒ ì œì–´, íŒŒì¼ ì¶œë ¥"
              
              if checkov "${checkov_args[@]}"; then
                echo "âœ… Checkov $output_format ì¶œë ¥ ì„±ê³µ"
                return 0
              else
                retry_count=$((retry_count + 1))
                if [ $retry_count -lt $max_retries ]; then
                  echo "âš ï¸ Checkov ì‹¤í–‰ ì‹¤íŒ¨ - 3ì´ˆ í›„ ì¬ì‹œë„..."
                  sleep 3
                else
                  echo "âŒ Checkov $output_format ì¶œë ¥ ìµœì¢… ì‹¤íŒ¨"
                  return 1
                fi
              fi
            done
          }
          
          # JSON í˜•ì‹ìœ¼ë¡œ ìŠ¤ìº” ì‹¤í–‰
          if ! run_checkov "json" "checkov-results.json"; then
            echo "âš ï¸ Checkov JSON ì¶œë ¥ ì‹¤íŒ¨ - ê¸°ë³¸ JSON íŒŒì¼ ìƒì„±"
          fi
          
          # Checkovê°€ ë””ë ‰í„°ë¦¬ êµ¬ì¡°ë¡œ ìƒì„±í•œ ê²½ìš° íŒŒì¼ ì´ë™
          if [ -d "checkov-results.json" ] && [ -f "checkov-results.json/results_json.json" ]; then
            echo "ğŸ”„ Checkov JSON ê²°ê³¼ íŒŒì¼ ì´ë™ ì¤‘..."
            mv "checkov-results.json/results_json.json" "checkov-results.json.tmp"
            rm -rf "checkov-results.json"
            mv "checkov-results.json.tmp" "checkov-results.json"
            echo "âœ… JSON íŒŒì¼ ì´ë™ ì™„ë£Œ"
          fi
          
          # SARIF í˜•ì‹ìœ¼ë¡œ ìŠ¤ìº” ì‹¤í–‰
          if ! run_checkov "sarif" "checkov-results.sarif"; then
            echo "âš ï¸ Checkov SARIF ì¶œë ¥ ì‹¤íŒ¨ - ê¸°ë³¸ SARIF íŒŒì¼ì€ ë‚˜ì¤‘ì— ìƒì„±ë©ë‹ˆë‹¤"
          fi
          
          # Checkovê°€ ë””ë ‰í„°ë¦¬ êµ¬ì¡°ë¡œ ìƒì„±í•œ ê²½ìš° íŒŒì¼ ì´ë™
          if [ -d "checkov-results.sarif" ] && [ -f "checkov-results.sarif/results_sarif.sarif" ]; then
            echo "ğŸ”„ Checkov SARIF ê²°ê³¼ íŒŒì¼ ì´ë™ ì¤‘..."
            mv "checkov-results.sarif/results_sarif.sarif" "checkov-results.sarif.tmp"
            rm -rf "checkov-results.sarif"
            mv "checkov-results.sarif.tmp" "checkov-results.sarif"
            echo "âœ… SARIF íŒŒì¼ ì´ë™ ì™„ë£Œ"
          fi
          
          # JSON ê²°ê³¼ íŒŒì¼ ì¡´ì¬ í™•ì¸ ë° ê¸°ë³¸ íŒŒì¼ ìƒì„± (Requirement 7.1)
          if [ ! -f "checkov-results.json" ]; then
            echo "âš ï¸ Checkov JSON ê²°ê³¼ íŒŒì¼ì´ ìƒì„±ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤. ê¸°ë³¸ íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤."
            cat > checkov-results.json << 'EOF'
          {
            "check_type": "kubernetes",
            "results": {
              "failed_checks": []
            },
            "summary": {
              "passed": 0,
              "failed": 0,
              "skipped": 0,
              "parsing_errors": 0,
              "resource_count": 0,
              "checkov_version": "unknown"
            }
          }
          EOF
          fi
          
          # ê²°ê³¼ íŒŒì¼ ê²€ì¦
          echo "ğŸ” ê²°ê³¼ íŒŒì¼ ê²€ì¦..."
          if python3 -c "import json; json.load(open('checkov-results.json'))" 2>/dev/null; then
            echo "âœ… JSON íŒŒì¼ í˜•ì‹ ê²€ì¦ ì™„ë£Œ"
          else
            echo "âŒ JSON íŒŒì¼ í˜•ì‹ ì˜¤ë¥˜ - ê¸°ë³¸ íŒŒì¼ë¡œ êµì²´"
            echo '{"check_type":"kubernetes","results":{"failed_checks":[]},"summary":{"passed":0,"failed":0,"skipped":0,"parsing_errors":0,"resource_count":0,"checkov_version":"unknown"}}' > checkov-results.json
          fi
          
          # ìŠ¤ìº” ê²°ê³¼ ìš”ì•½
          ISSUES_COUNT=$(python3 -c "import json; data=json.load(open('checkov-results.json')); print(len(data.get('results', {}).get('failed_checks', [])))" 2>/dev/null || echo "0")
          echo "ğŸ“Š ìŠ¤ìº” ì™„ë£Œ - ë°œê²¬ëœ ì´ìŠˆ: ${ISSUES_COUNT}ê°œ"
          echo "âœ… Kubernetes ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ"
          
          # ì„±ëŠ¥ í†µê³„ ìˆ˜ì§‘
          echo "â±ï¸ ì„±ëŠ¥ í†µê³„:"
          echo "  - ìŠ¤ìº”ëœ íŒŒì¼ ìˆ˜: ${TOTAL_FILES}ê°œ (YAML: ${YAML_FILES}, JSON: ${JSON_FILES})"
          echo "  - ë°œê²¬ëœ ì´ìŠˆ ìˆ˜: ${ISSUES_COUNT}ê°œ"
          echo "  - ìŠ¤ìº” ì™„ë£Œ ì‹œê°„: $(date)"
          
          # ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ í™•ì¸
          echo "ğŸ§  ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰:"
          free -h

      - name: OpenAI ë³´ì•ˆ ë¶„ì„ ì‹¤í–‰ (Requirements 2.1, 2.3, 5.1)
        if: steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          MAX_ISSUES_FOR_AI: 15
        run: |
          echo "ğŸ¤– ë³´ì•ˆ ë¶„ì„ì„ ì‹œì‘í•©ë‹ˆë‹¤..."
          python scripts/analyze_security.py checkov-results.json kubernetes > security-analysis-report.md
          echo "âœ… ë³´ì•ˆ ë¶„ì„ ì™„ë£Œ"
          echo "ğŸ“„ ë¶„ì„ ë¦¬í¬íŠ¸ ë¯¸ë¦¬ë³´ê¸°:"
          head -20 security-analysis-report.md

      - name: ì´ìŠˆ ê°œìˆ˜ í™•ì¸ ë° í™˜ê²½ë³€ìˆ˜ ì„¤ì •
        if: steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        id: issue_count
        run: |
          # ë©”íƒ€ë°ì´í„° ì¶”ì¶œì„ ìœ„í•´ ë¶„ì„ ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          METADATA_OUTPUT=$(python scripts/analyze_security.py checkov-results.json kubernetes --metadata-only)
          
          # í™˜ê²½ë³€ìˆ˜ íŒŒì‹±
          TOTAL_ISSUES=$(echo "$METADATA_OUTPUT" | grep "TOTAL_ISSUES=" | cut -d'=' -f2)
          CRITICAL_COUNT=$(echo "$METADATA_OUTPUT" | grep "CRITICAL_COUNT=" | cut -d'=' -f2)
          HIGH_COUNT=$(echo "$METADATA_OUTPUT" | grep "HIGH_COUNT=" | cut -d'=' -f2)
          MEDIUM_COUNT=$(echo "$METADATA_OUTPUT" | grep "MEDIUM_COUNT=" | cut -d'=' -f2)
          LOW_COUNT=$(echo "$METADATA_OUTPUT" | grep "LOW_COUNT=" | cut -d'=' -f2)
          ISSUE_PRIORITY=$(echo "$METADATA_OUTPUT" | grep "ISSUE_PRIORITY=" | cut -d'=' -f2)
          ISSUE_TITLE=$(echo "$METADATA_OUTPUT" | grep "ISSUE_TITLE=" | cut -d'=' -f2)
          ISSUE_LABELS=$(echo "$METADATA_OUTPUT" | grep "ISSUE_LABELS=" | cut -d'=' -f2)
          
          # GitHub Actions ì¶œë ¥ ì„¤ì •
          echo "total_issues=$TOTAL_ISSUES" >> $GITHUB_OUTPUT
          echo "critical_count=$CRITICAL_COUNT" >> $GITHUB_OUTPUT
          echo "high_count=$HIGH_COUNT" >> $GITHUB_OUTPUT
          echo "medium_count=$MEDIUM_COUNT" >> $GITHUB_OUTPUT
          echo "low_count=$LOW_COUNT" >> $GITHUB_OUTPUT
          echo "priority=$ISSUE_PRIORITY" >> $GITHUB_OUTPUT
          echo "issue_title=$ISSUE_TITLE" >> $GITHUB_OUTPUT
          echo "issue_labels=$ISSUE_LABELS" >> $GITHUB_OUTPUT
          
          echo "ğŸ“Š ì´ìŠˆ í†µê³„: ì´ $TOTAL_ISSUESê°œ (Critical: $CRITICAL_COUNT, High: $HIGH_COUNT, Medium: $MEDIUM_COUNT, Low: $LOW_COUNT)"

      - name: GitHub Issue ìƒì„± (Requirements 2.4, 3.3)
        if: (steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule') && steps.issue_count.outputs.total_issues > 0
        uses: actions/github-script@v7
        with:
          script: |
            const totalIssues = '${{ steps.issue_count.outputs.total_issues }}';
            const priority = '${{ steps.issue_count.outputs.priority }}';
            const criticalCount = '${{ steps.issue_count.outputs.critical_count }}';
            const highCount = '${{ steps.issue_count.outputs.high_count }}';
            const mediumCount = '${{ steps.issue_count.outputs.medium_count }}';
            const lowCount = '${{ steps.issue_count.outputs.low_count }}';
            const reason = '${{ steps.reason.outputs.reason }}';
            const runUrl = `https://github.com/${context.repo.owner}/${context.repo.repo}/actions/runs/${context.runId}`;
            
            // ë¶„ì„ ë¦¬í¬íŠ¸ ì½ê¸°
            let analysisReport = '';
            try {
              analysisReport = fs.readFileSync('security-analysis-report.md', 'utf8');
            } catch (error) {
              analysisReport = 'ë¶„ì„ ë¦¬í¬íŠ¸ë¥¼ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.';
            }
            
            const title = `div4u K8s ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼: ${totalIssues}ê°œ ì´ìŠˆ ë°œê²¬ (${priority})`;
            
            const body = `## â˜¸ï¸ div4u Kubernetes ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼
            
            ### ğŸ“Š ê²€ì‚¬ ìš”ì•½
            - **ì´ ì´ìŠˆ**: ${totalIssues}ê°œ
            - **ìš°ì„ ìˆœìœ„**: ${priority}
            - **ì‹¤í–‰ ì´ìœ **: ${reason}
            - **ë¸Œëœì¹˜**: \`${context.ref.replace('refs/heads/', '')}\`
            - **ì»¤ë°‹**: \`${context.sha.substring(0, 7)}\`
            - **ì‹¤í–‰ ì‹œê°„**: ${new Date().toLocaleString('ko-KR', {timeZone: 'Asia/Seoul'})}
            
            ### ğŸ“ˆ ì‹¬ê°ë„ë³„ ë¶„í¬
            | ì‹¬ê°ë„ | ê°œìˆ˜ |
            |--------|------|
            | ğŸ”´ Critical | ${criticalCount} |
            | ğŸŸ  High | ${highCount} |
            | ğŸŸ¡ Medium | ${mediumCount} |
            | ğŸŸ¢ Low | ${lowCount} |
            
            ### ğŸ¤– AI ë¶„ì„ ê²°ê³¼
            ${analysisReport}
            
            ### âœ… í•´ê²° ì²´í¬ë¦¬ìŠ¤íŠ¸
            - [ ] Critical ì´ìŠˆ í•´ê²° (${criticalCount}ê°œ)
            - [ ] High ì´ìŠˆ í•´ê²° (${highCount}ê°œ)
            - [ ] Medium ì´ìŠˆ ê²€í†  ë° í•´ê²° (${mediumCount}ê°œ)
            - [ ] ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ ë° ë¦¬ì†ŒìŠ¤ ì œí•œ ì„¤ì • ê²€í† 
            - [ ] ë„¤íŠ¸ì›Œí¬ ì •ì±… ë° RBAC ì„¤ì • ê²€í† 
            - [ ] ì»¨í…Œì´ë„ˆ ì´ë¯¸ì§€ ë³´ì•ˆ ê²€í† 
            - [ ] ë³´ì•ˆ ì •ì±… ì—…ë°ì´íŠ¸
            - [ ] íŒ€ ë¦¬ë·° ì™„ë£Œ
            
            ### ğŸ”— ê´€ë ¨ ë§í¬
            - [ì›Œí¬í”Œë¡œ ì‹¤í–‰ ê²°ê³¼](${runUrl})
            - [k8s-test-scenario ë””ë ‰í„°ë¦¬](${context.payload.repository.html_url}/tree/${context.ref.replace('refs/heads/', '')}/k8s-test-scenario)
            - [Checkov Kubernetes ë¬¸ì„œ](https://www.checkov.io/5.Policy%20Index/kubernetes.html)
            - [Kubernetes ë³´ì•ˆ ê°€ì´ë“œ](https://kubernetes.io/docs/concepts/security/)
            
            ---
            *ì´ ì´ìŠˆëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ë¬¸ì œ í•´ê²° í›„ ì´ìŠˆë¥¼ ë‹«ì•„ì£¼ì„¸ìš”.*`;
            
            // ë¼ë²¨ ì„¤ì • (ì‹¬ê°ë„ë³„ ìš°ì„ ìˆœìœ„ í¬í•¨)
            const labels = ['security', 'checkov', 'kubernetes', 'automated'];
            if (priority === 'CRITICAL') labels.push('priority:critical');
            else if (priority === 'HIGH') labels.push('priority:high');
            else if (priority === 'MEDIUM') labels.push('priority:medium');
            else labels.push('priority:low');
            
            // ì´ìŠˆ ìƒì„±
            const issue = await github.rest.issues.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: title,
              body: body,
              labels: labels
            });
            
            console.log(`âœ… GitHub Issue ìƒì„± ì™„ë£Œ: #${issue.data.number}`);
            
            // ì´ìŠˆ ë²ˆí˜¸ë¥¼ í™˜ê²½ë³€ìˆ˜ë¡œ ì„¤ì •
            const fs = require('fs');
            fs.appendFileSync(process.env.GITHUB_ENV, `ISSUE_NUMBER=${issue.data.number}\n`);

      - name: Slack ì•Œë¦¼ ì „ì†¡ (Requirements 3.1, 3.2, 3.3)
        if: steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule'
        env:
          SLACK_WEBHOOK_URL_CHECKOV: ${{ secrets.SLACK_WEBHOOK_URL_CHECKOV }}
          GITHUB_REF: ${{ github.ref }}
          GITHUB_EVENT_NAME: ${{ github.event_name }}
          ISSUE_URL: ${{ env.ISSUE_NUMBER && format('https://github.com/{0}/issues/{1}', github.repository, env.ISSUE_NUMBER) || '' }}
        run: |
          echo "ğŸ“± Slack ì•Œë¦¼ì„ ì „ì†¡í•©ë‹ˆë‹¤..."
          python scripts/analyze_security.py checkov-results.json kubernetes --slack-notify || echo "âš ï¸ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨ (íŒŒì´í”„ë¼ì¸ì€ ê³„ì† ì§„í–‰)"

      - name: SARIF íŒŒì¼ ê²€ì¦ ë° ë©”íƒ€ë°ì´í„° ì¶”ê°€ (Requirements 1.3, 7.4)
        if: (steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule') && always()
        run: |
          echo "ğŸ” SARIF íŒŒì¼ ê²€ì¦ ë° ë©”íƒ€ë°ì´í„° ì¶”ê°€..."
          
          # SARIF íŒŒì¼ ì¡´ì¬ í™•ì¸
          if [ ! -f "checkov-results.sarif" ]; then
            echo "âš ï¸ SARIF íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤. ê¸°ë³¸ SARIF íŒŒì¼ì„ ìƒì„±í•©ë‹ˆë‹¤."
            cat > checkov-results.sarif << 'EOF'
          {
            "$schema": "https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json",
            "version": "2.1.0",
            "runs": [
              {
                "tool": {
                  "driver": {
                    "name": "checkov",
                    "version": "unknown",
                    "informationUri": "https://www.checkov.io/",
                    "rules": []
                  }
                },
                "results": [],
                "properties": {
                  "repository": "${{ github.repository }}",
                  "branch": "${{ github.ref_name }}",
                  "commit": "${{ github.sha }}",
                  "workflow_run": "${{ github.run_id }}",
                  "scan_type": "kubernetes",
                  "scan_directory": "k8s-test-scenario",
                  "scan_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
                }
              }
            ]
          }
          EOF
          fi
          
          # SARIF íŒŒì¼ ìœ íš¨ì„± ê²€ì‚¬ ë° ë©”íƒ€ë°ì´í„° ì¶”ê°€
          python3 -c "
          import json
          import sys
          try:
              with open('checkov-results.sarif', 'r') as f:
                  sarif_data = json.load(f)
              
              # ê¸°ë³¸ êµ¬ì¡° ê²€ì¦
              if 'runs' not in sarif_data:
                  print('âŒ SARIF íŒŒì¼ êµ¬ì¡° ì˜¤ë¥˜: runs ì„¹ì…˜ì´ ì—†ìŠµë‹ˆë‹¤.')
                  sys.exit(1)
              
              # ë©”íƒ€ë°ì´í„° ì¶”ê°€
              for run in sarif_data['runs']:
                  if 'properties' not in run:
                      run['properties'] = {}
                  
                  run['properties'].update({
                      'repository': '${{ github.repository }}',
                      'branch': '${{ github.ref_name }}',
                      'commit': '${{ github.sha }}',
                      'workflow_run': '${{ github.run_id }}',
                      'scan_type': 'kubernetes',
                      'scan_directory': 'k8s-test-scenario',
                      'scan_time': '$(date -u +%Y-%m-%dT%H:%M:%SZ)',
                      'total_issues': '${{ steps.issue_count.outputs.total_issues || 0 }}',
                      'critical_count': '${{ steps.issue_count.outputs.critical_count || 0 }}',
                      'high_count': '${{ steps.issue_count.outputs.high_count || 0 }}',
                      'medium_count': '${{ steps.issue_count.outputs.medium_count || 0 }}',
                      'low_count': '${{ steps.issue_count.outputs.low_count || 0 }}'
                  })
              
              # ì—…ë°ì´íŠ¸ëœ SARIF íŒŒì¼ ì €ì¥
              with open('checkov-results.sarif', 'w') as f:
                  json.dump(sarif_data, f, indent=2)
              
              print('âœ… SARIF íŒŒì¼ ê²€ì¦ ë° ë©”íƒ€ë°ì´í„° ì¶”ê°€ ì™„ë£Œ')
              print(f'ğŸ“Š ê²°ê³¼ ìˆ˜: {len(sarif_data[\"runs\"][0].get(\"results\", []))}ê°œ')
              
          except json.JSONDecodeError as e:
              print(f'âŒ SARIF íŒŒì¼ JSON íŒŒì‹± ì˜¤ë¥˜: {e}')
              sys.exit(1)
          except Exception as e:
              print(f'âŒ SARIF íŒŒì¼ ì²˜ë¦¬ ì˜¤ë¥˜: {e}')
              sys.exit(1)
          "

      - name: ì•„í‹°íŒ©íŠ¸ ë©”íƒ€ë°ì´í„° ìƒì„± (Requirements 7.4)
        if: (steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule') && always()
        run: |
          echo "ğŸ“ ì•„í‹°íŒ©íŠ¸ ë©”íƒ€ë°ì´í„° ìƒì„±..."
          
          # ìŠ¤ìº” ëŒ€ìƒ íŒŒì¼ ëª©ë¡ ìƒì„±
          SCANNED_FILES=$(find k8s-test-scenario -type f \( -name "*.yaml" -o -name "*.yml" \) 2>/dev/null | jq -R . | jq -s . || echo '[]')
          
          # ìŠ¤ìº” ë©”íƒ€ë°ì´í„° íŒŒì¼ ìƒì„±
          cat > scan-metadata.json << EOF
          {
            "scan_info": {
              "repository": "${{ github.repository }}",
              "branch": "${{ github.ref_name }}",
              "commit": "${{ github.sha }}",
              "commit_message": $(echo '${{ github.event.head_commit.message }}' | jq -R .),
              "workflow_run_id": "${{ github.run_id }}",
              "workflow_run_url": "https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}",
              "scan_type": "kubernetes",
              "scan_directory": "k8s-test-scenario",
              "scan_time": "$(date -u +%Y-%m-%dT%H:%M:%SZ)",
              "trigger_event": "${{ github.event_name }}",
              "trigger_reason": "${{ steps.reason.outputs.reason }}"
            },
            "results_summary": {
              "total_issues": ${{ steps.issue_count.outputs.total_issues || 0 }},
              "critical_count": ${{ steps.issue_count.outputs.critical_count || 0 }},
              "high_count": ${{ steps.issue_count.outputs.high_count || 0 }},
              "medium_count": ${{ steps.issue_count.outputs.medium_count || 0 }},
              "low_count": ${{ steps.issue_count.outputs.low_count || 0 }},
              "priority": "${{ steps.issue_count.outputs.priority || 'NONE' }}"
            },
            "scan_scope": {
              "target_directory": "k8s-test-scenario",
              "scanned_files": $SCANNED_FILES,
              "file_count": $(echo '$SCANNED_FILES' | jq length)
            },
            "files_info": {
              "checkov_json": "checkov-results.json",
              "checkov_sarif": "checkov-results.sarif",
              "analysis_report": "security-analysis-report.md",
              "metadata": "scan-metadata.json"
            },
            "github_integration": {
              "issue_created": ${{ steps.issue_count.outputs.total_issues > 0 && 'true' || 'false' }},
              "issue_number": "${{ env.ISSUE_NUMBER || '' }}",
              "issue_url": "${{ env.ISSUE_NUMBER && format('https://github.com/{0}/issues/{1}', github.repository, env.ISSUE_NUMBER) || '' }}",
              "sarif_uploaded": true,
              "artifacts_uploaded": true
            }
          }
          EOF
          
          echo "âœ… ë©”íƒ€ë°ì´í„° íŒŒì¼ ìƒì„± ì™„ë£Œ"
          echo "ğŸ“„ ë©”íƒ€ë°ì´í„° ë¯¸ë¦¬ë³´ê¸°:"
          cat scan-metadata.json | jq .

      - name: SARIF ì—…ë¡œë“œ (Requirements 1.3, 7.4)
        if: (steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule') && always()
        uses: github/codeql-action/upload-sarif@v3
        continue-on-error: true  # í¬í¬ PRì—ì„œ ì‹¤íŒ¨í•  ìˆ˜ ìˆìŒ
        with:
          sarif_file: checkov-results.sarif
          category: div4u-kubernetes-security
          checkout_path: ${{ github.workspace }}
          wait-for-processing: false

      - name: SARIF ì—…ë¡œë“œ ê²°ê³¼ í™•ì¸
        if: (steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule') && always()
        run: |
          echo "ğŸ“¤ SARIF ì—…ë¡œë“œ ìƒíƒœ í™•ì¸..."
          if [ -f "checkov-results.sarif" ]; then
            SARIF_SIZE=$(stat -c%s checkov-results.sarif)
            echo "âœ… SARIF íŒŒì¼ í¬ê¸°: ${SARIF_SIZE} bytes"
            
            # SARIF íŒŒì¼ ë‚´ìš© ìš”ì•½
            python3 -c "
            import json
            try:
                with open('checkov-results.sarif', 'r') as f:
                    sarif = json.load(f)
                results_count = len(sarif['runs'][0].get('results', []))
                tool_name = sarif['runs'][0]['tool']['driver']['name']
                scan_dir = sarif['runs'][0].get('properties', {}).get('scan_directory', 'unknown')
                print(f'ğŸ“Š ë„êµ¬: {tool_name}')
                print(f'ğŸ“Š ìŠ¤ìº” ë””ë ‰í„°ë¦¬: {scan_dir}')
                print(f'ğŸ“Š ë°œê²¬ëœ ì´ìŠˆ: {results_count}ê°œ')
                print('âœ… SARIF ì—…ë¡œë“œ ì¤€ë¹„ ì™„ë£Œ')
            except Exception as e:
                print(f'âš ï¸ SARIF íŒŒì¼ ë¶„ì„ ì˜¤ë¥˜: {e}')
            "
          else
            echo "âŒ SARIF íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤."
          fi

      - name: ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ (Requirements 7.4)
        if: (steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule') && always()
        uses: actions/upload-artifact@v4
        with:
          name: div4u-k8s-security-scan-results-${{ github.run_number }}
          path: |
            checkov-results.json
            checkov-results.sarif
            security-analysis-report.md
            scan-metadata.json
          retention-days: 30
          if-no-files-found: warn
          compression-level: 6

      - name: ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ ê²°ê³¼ í™•ì¸
        if: (steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule') && always()
        run: |
          echo "ğŸ“¦ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ ì™„ë£Œ í™•ì¸..."
          echo "ğŸ“ ì—…ë¡œë“œëœ íŒŒì¼ë“¤:"
          
          for file in checkov-results.json checkov-results.sarif security-analysis-report.md scan-metadata.json; do
            if [ -f "$file" ]; then
              SIZE=$(stat -c%s "$file" 2>/dev/null || echo "0")
              echo "  âœ… $file (${SIZE} bytes)"
            else
              echo "  âŒ $file (íŒŒì¼ ì—†ìŒ)"
            fi
          done
          
          echo ""
          echo "ğŸ”— ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ ë§í¬:"
          echo "   https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo ""
          echo "ğŸ“… ë³´ì¡´ ê¸°ê°„: 30ì¼"
          echo "ğŸ·ï¸ ì•„í‹°íŒ©íŠ¸ ì´ë¦„: div4u-k8s-security-scan-results-${{ github.run_number }}"

      - name: PR Gate ê²€ì‚¬ (Requirements 4.1, 4.2, 4.3)
        if: (steps.changes.outputs.k8s == 'true' || github.event_name == 'workflow_dispatch' || github.event_name == 'schedule')
        env:
          FAIL_ON_SEVERITY: ${{ vars.FAIL_ON_SEVERITY || 'none' }}
        run: |
          TOTAL_ISSUES="${{ steps.issue_count.outputs.total_issues }}"
          CRITICAL_COUNT="${{ steps.issue_count.outputs.critical_count }}"
          HIGH_COUNT="${{ steps.issue_count.outputs.high_count }}"
          MEDIUM_COUNT="${{ steps.issue_count.outputs.medium_count }}"
          LOW_COUNT="${{ steps.issue_count.outputs.low_count }}"
          
          echo "ğŸšª PR Gate ê²€ì‚¬ ì‹œì‘ (ì„ê³„ì¹˜: $FAIL_ON_SEVERITY)"
          echo "ğŸ“Š ì´ìŠˆ í˜„í™©: Critical=$CRITICAL_COUNT, High=$HIGH_COUNT, Medium=$MEDIUM_COUNT, Low=$LOW_COUNT"
          
          # ì„ê³„ì¹˜ê°€ 'none'ì´ë©´ Gate ê²€ì‚¬ë¥¼ ê±´ë„ˆëœ€
          if [ "$FAIL_ON_SEVERITY" = "none" ]; then
            echo "â­ï¸ PR Gateê°€ ë¹„í™œì„±í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤ (FAIL_ON_SEVERITY=none)"
            echo "âœ… ëª¨ë“  ì´ìŠˆì™€ ê´€ê³„ì—†ì´ ì›Œí¬í”Œë¡œë¥¼ í†µê³¼ì‹œí‚µë‹ˆë‹¤."
            exit 0
          fi
          
          SHOULD_FAIL=false
          FAIL_REASON=""
          
          case "$FAIL_ON_SEVERITY" in
            "critical")
              if [ "$CRITICAL_COUNT" -ge 1 ]; then
                echo "âŒ Gate ì‹¤íŒ¨: Critical ì´ìŠˆ ${CRITICAL_COUNT}ê°œ ë°œê²¬ (ì„ê³„ì¹˜: 1ê°œ ì´ìƒ)"
                FAIL_REASON="Critical ì´ìŠˆ ${CRITICAL_COUNT}ê°œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
                SHOULD_FAIL=true
              fi
              ;;
            "high")
              if [ "$CRITICAL_COUNT" -ge 1 ]; then
                echo "âŒ Gate ì‹¤íŒ¨: Critical ì´ìŠˆ ${CRITICAL_COUNT}ê°œ ë°œê²¬ (ì„ê³„ì¹˜: Criticalâ‰¥1)"
                FAIL_REASON="Critical ì´ìŠˆ ${CRITICAL_COUNT}ê°œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
                SHOULD_FAIL=true
              elif [ "$HIGH_COUNT" -ge 3 ]; then
                echo "âŒ Gate ì‹¤íŒ¨: High ì´ìŠˆ ${HIGH_COUNT}ê°œ ë°œê²¬ (ì„ê³„ì¹˜: Highâ‰¥3)"
                FAIL_REASON="High ì´ìŠˆ ${HIGH_COUNT}ê°œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
                SHOULD_FAIL=true
              fi
              ;;
            "medium")
              if [ "$CRITICAL_COUNT" -ge 1 ]; then
                echo "âŒ Gate ì‹¤íŒ¨: Critical ì´ìŠˆ ${CRITICAL_COUNT}ê°œ ë°œê²¬ (ì„ê³„ì¹˜: Criticalâ‰¥1)"
                FAIL_REASON="Critical ì´ìŠˆ ${CRITICAL_COUNT}ê°œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
                SHOULD_FAIL=true
              elif [ "$HIGH_COUNT" -ge 3 ]; then
                echo "âŒ Gate ì‹¤íŒ¨: High ì´ìŠˆ ${HIGH_COUNT}ê°œ ë°œê²¬ (ì„ê³„ì¹˜: Highâ‰¥3)"
                FAIL_REASON="High ì´ìŠˆ ${HIGH_COUNT}ê°œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
                SHOULD_FAIL=true
              elif [ "$MEDIUM_COUNT" -ge 5 ]; then
                echo "âŒ Gate ì‹¤íŒ¨: Medium ì´ìŠˆ ${MEDIUM_COUNT}ê°œ ë°œê²¬ (ì„ê³„ì¹˜: Mediumâ‰¥5)"
                FAIL_REASON="Medium ì´ìŠˆ ${MEDIUM_COUNT}ê°œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
                SHOULD_FAIL=true
              fi
              ;;
            "low")
              if [ "$TOTAL_ISSUES" -ge 10 ]; then
                echo "âŒ Gate ì‹¤íŒ¨: ì´ ì´ìŠˆ ${TOTAL_ISSUES}ê°œ ë°œê²¬ (ì„ê³„ì¹˜: 10ê°œ ì´ìƒ)"
                FAIL_REASON="ì´ ${TOTAL_ISSUES}ê°œì˜ ë³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤."
                SHOULD_FAIL=true
              fi
              ;;
            *)
              echo "âš ï¸ ì•Œ ìˆ˜ ì—†ëŠ” FAIL_ON_SEVERITY ê°’: $FAIL_ON_SEVERITY"
              echo "ğŸ’¡ ìœ íš¨í•œ ê°’: none, low, medium, high, critical"
              echo "âœ… ê¸°ë³¸ê°’ìœ¼ë¡œ Gateë¥¼ í†µê³¼ì‹œí‚µë‹ˆë‹¤."
              exit 0
              ;;
          esac
          
          if [ "$SHOULD_FAIL" = true ]; then
            echo ""
            echo "ğŸš« PR Gate: ë³´ì•ˆ ì„ê³„ì¹˜ë¥¼ ì´ˆê³¼í•˜ì—¬ ì›Œí¬í”Œë¡œë¥¼ ì‹¤íŒ¨ ì²˜ë¦¬í•©ë‹ˆë‹¤."
            echo "ğŸ“‹ ì‹¤íŒ¨ ì‚¬ìœ : $FAIL_REASON"
            echo ""
            echo "ğŸ’¡ í•´ê²° ë°©ë²•:"
            echo "  1. k8s-test-scenario ë””ë ‰í„°ë¦¬ì˜ ë³´ì•ˆ ì´ìŠˆë¥¼ í•´ê²°í•˜ì„¸ìš”"
            echo "  2. ì´ìŠˆ í•´ê²° í›„ ë‹¤ì‹œ ì»¤ë°‹í•˜ê±°ë‚˜ PRì„ ì—…ë°ì´íŠ¸í•˜ì„¸ìš”"
            echo "  3. ë˜ëŠ” FAIL_ON_SEVERITY í™˜ê²½ë³€ìˆ˜ë¥¼ ì¡°ì •í•˜ì„¸ìš”"
            echo ""
            echo "ğŸ”— ê´€ë ¨ ë§í¬:"
            echo "  - GitHub Issue: https://github.com/${{ github.repository }}/issues"
            echo "  - Checkov K8s ë¬¸ì„œ: https://www.checkov.io/5.Policy%20Index/kubernetes.html"
            echo "  - Kubernetes ë³´ì•ˆ ê°€ì´ë“œ: https://kubernetes.io/docs/concepts/security/"
            echo ""
            exit 1
          else
            echo "âœ… PR Gate: ë³´ì•ˆ ì„ê³„ì¹˜ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤."
            echo "ğŸ“Š í˜„ì¬ ì„¤ì •: FAIL_ON_SEVERITY=$FAIL_ON_SEVERITY"
            echo "ğŸ‰ ì›Œí¬í”Œë¡œë¥¼ ì„±ê³µì ìœ¼ë¡œ ì™„ë£Œí•©ë‹ˆë‹¤."
          fi

      - name: ë³€ê²½ì‚¬í•­ ì—†ìŒ ì²˜ë¦¬
        if: steps.changes.outputs.k8s != 'true' && github.event_name != 'workflow_dispatch' && github.event_name != 'schedule'
        run: |
          echo "â­ï¸ k8s-test-scenario ë””ë ‰í„°ë¦¬ì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          echo "ğŸ“ ëª¨ë‹ˆí„°ë§ ëŒ€ìƒ: k8s-test-scenario/**"
          echo "::notice::ë³€ê²½ì‚¬í•­ ì—†ìŒ - ë³´ì•ˆ ìŠ¤ìº”ì„ ê±´ë„ˆëœë‹ˆë‹¤."

      - name: ì‹¤í–‰ ì™„ë£Œ ìš”ì•½
        if: always()
        run: |
          echo "ğŸ‰ div4u Kubernetes ë³´ì•ˆ ë¶„ì„ ì›Œí¬í”Œë¡œ ì™„ë£Œ"
          echo "ğŸ“Š ì‹¤í–‰ ê²°ê³¼:"
          echo "  - ë³€ê²½ ê°ì§€: ${{ steps.changes.outputs.k8s }}"
          echo "  - ì´ ì´ìŠˆ: ${{ steps.issue_count.outputs.total_issues || '0' }}ê°œ"
          echo "  - ì‹¤í–‰ ì´ìœ : ${{ steps.reason.outputs.reason }}"
          echo "  - ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo ""
          echo "ğŸ”— ì¶”ê°€ ì •ë³´:"
          echo "  - ì›Œí¬í”Œë¡œ ì‹¤í–‰: https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }}"
          echo "  - ìŠ¤ìº” ëŒ€ìƒ: k8s-test-scenario ë””ë ‰í„°ë¦¬"