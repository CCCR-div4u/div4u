name: Kubernetes Security Scan

on:
  push:
    branches: [main, develop, 'feature/k8s-security-scan']
    paths:
      - 'k8s/**'
      - '.github/workflows/k8s-security-scan.yaml'
  pull_request:
    branches: [main, develop]
    paths:
      - 'k8s/**'
      - '.github/workflows/k8s-security-scan.yaml'
  workflow_dispatch:
  schedule:
    # ë§¤ì¼ ì˜¤ì „ 9ì‹œ UTCì— ì •ê¸° ìŠ¤ìº” (main ë¸Œëœì¹˜ì—ì„œë§Œ)
    - cron: '0 9 * * *'

permissions:
  contents: read
  security-events: write
  issues: write
  pull-requests: write

concurrency:
  group: k8s-security-${{ github.ref }}
  cancel-in-progress: true

jobs:
  # ë³€ê²½ ê°ì§€ ë° ìŠ¤ìº” ì¤€ë¹„
  detect-changes:
    runs-on: ubuntu-latest
    outputs:
      k8s_changed: ${{ steps.filter.outputs.k8s }}
      workflow_changed: ${{ steps.filter.outputs.workflow }}
      should_scan: ${{ steps.decide.outputs.should_scan }}
      scan_reason: ${{ steps.decide.outputs.scan_reason }}
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Detect changed paths
        uses: dorny/paths-filter@v3
        id: filter
        with:
          filters: |
            k8s:
              - 'k8s/**'
            workflow:
              - '.github/workflows/k8s-security-scan.yaml'

      - name: Decide scan execution
        id: decide
        run: |
          # ìŠ¤ì¼€ì¤„ ì‹¤í–‰ì¸ ê²½ìš°
          if [ "${{ github.event_name }}" = "schedule" ]; then
            echo "should_scan=true" >> $GITHUB_OUTPUT
            echo "scan_reason=ì •ê¸° ë³´ì•ˆ ê²€ì‚¬ (ìŠ¤ì¼€ì¤„)" >> $GITHUB_OUTPUT
            echo "ğŸ“… ì •ê¸° ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰"
            exit 0
          fi
          
          # ìˆ˜ë™ ì‹¤í–‰ì¸ ê²½ìš°
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "should_scan=true" >> $GITHUB_OUTPUT
            echo "scan_reason=ìˆ˜ë™ ì‹¤í–‰" >> $GITHUB_OUTPUT
            echo "ğŸ”§ ìˆ˜ë™ ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰"
            exit 0
          fi
          
          # ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë³€ê²½ì¸ ê²½ìš°
          if [ "${{ steps.filter.outputs.workflow }}" = "true" ]; then
            echo "should_scan=true" >> $GITHUB_OUTPUT
            echo "scan_reason=ì›Œí¬í”Œë¡œìš° íŒŒì¼ ë³€ê²½" >> $GITHUB_OUTPUT
            echo "ğŸ”„ ì›Œí¬í”Œë¡œìš° ë³€ê²½ìœ¼ë¡œ ì¸í•œ ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰"
            exit 0
          fi
          
          # k8s ë””ë ‰í„°ë¦¬ ë³€ê²½ì¸ ê²½ìš°
          if [ "${{ steps.filter.outputs.k8s }}" = "true" ]; then
            echo "should_scan=true" >> $GITHUB_OUTPUT
            echo "scan_reason=k8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë³€ê²½" >> $GITHUB_OUTPUT
            echo "ğŸ“¦ k8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë³€ê²½ìœ¼ë¡œ ì¸í•œ ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰"
            exit 0
          fi
          
          # ë³€ê²½ì‚¬í•­ì´ ì—†ëŠ” ê²½ìš°
          echo "should_scan=false" >> $GITHUB_OUTPUT
          echo "scan_reason=ë³€ê²½ì‚¬í•­ ì—†ìŒ" >> $GITHUB_OUTPUT
          echo "â­ï¸ ìŠ¤ìº” ëŒ€ìƒì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤"

  # Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë³´ì•ˆ ìŠ¤ìº”
  security-scan:
    needs: detect-changes
    if: needs.detect-changes.outputs.should_scan == 'true'
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Display scan info
        run: |
          echo "ğŸ” ë³´ì•ˆ ìŠ¤ìº” ì‹œì‘"
          echo "ğŸ“¦ ëŒ€ìƒ: div4u Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸"
          echo "ğŸ“ ìŠ¤ìº” ë””ë ‰í„°ë¦¬: k8s/"
          echo "ğŸ¯ ì‹¤í–‰ ì´ìœ : ${{ needs.detect-changes.outputs.scan_reason }}"
          echo "ğŸŒ¿ ë¸Œëœì¹˜: ${{ github.ref_name }}"
          echo "ğŸ“ ì»¤ë°‹: ${{ github.sha }}"
          echo ""
          echo "::notice::${{ needs.detect-changes.outputs.scan_reason }}ìœ¼ë¡œ ì¸í•œ ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰"

      - name: Create directories
        run: |
          mkdir -p reports results
          echo "ğŸ“ ë””ë ‰í„°ë¦¬ ìƒì„± ì™„ë£Œ: reports, results"

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Checkov
        run: |
          pip install checkov
          checkov --version
          echo "âœ… Checkov ì„¤ì¹˜ ì™„ë£Œ"

      - name: Run Checkov security scan
        run: |
          echo "ğŸ” Checkov ë³´ì•ˆ ìŠ¤ìº” ì‹œì‘..."
          
          # k8s ë””ë ‰í„°ë¦¬ì˜ ëª¨ë“  YAML íŒŒì¼ì„ í•˜ë‚˜ë¡œ í•©ì¹˜ê¸°
          echo "ğŸ“‹ Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ ìˆ˜ì§‘ ì¤‘..."
          find k8s -name "*.yaml" -o -name "*.yml" | while read -r file; do
            echo "ğŸ“„ ì²˜ë¦¬ ì¤‘: $file"
            echo "---" >> "results/all-manifests.yaml"
            cat "$file" >> "results/all-manifests.yaml"
          done
          
          # ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ í™•ì¸
          if [ ! -s "results/all-manifests.yaml" ]; then
            echo "âŒ Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤"
            exit 1
          fi
          
          LINES=$(wc -l < "results/all-manifests.yaml")
          SIZE=$(wc -c < "results/all-manifests.yaml")
          echo "âœ… ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìˆ˜ì§‘ ì™„ë£Œ: ${LINES}ì¤„, ${SIZE}ë°”ì´íŠ¸"
          
          # Checkov ìŠ¤ìº” ì‹¤í–‰ (JSON ì¶œë ¥)
          echo "ğŸ” Checkov ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰ ì¤‘..."
          checkov \
            --file results/all-manifests.yaml \
            --framework kubernetes \
            --output json \
            --soft-fail \
            --quiet > reports/checkov-results.json
          
          echo "ğŸ“Š JSON ê²°ê³¼ ìƒì„± ì™„ë£Œ"
          
          # JSON íŒŒì¼ í™•ì¸
          if [ -f "reports/checkov-results.json" ] && [ -s "reports/checkov-results.json" ]; then
            echo "âœ… JSON íŒŒì¼ ìƒì„± ì„±ê³µ: $(wc -c < reports/checkov-results.json) bytes"
          else
            echo "âŒ JSON íŒŒì¼ ìƒì„± ì‹¤íŒ¨"
            # ë¹ˆ JSON íŒŒì¼ ìƒì„±
            echo '{"check_type": "kubernetes", "results": {"failed_checks": []}, "summary": {"passed": 0, "failed": 0, "skipped": 0, "parsing_errors": 0, "resource_count": 0, "checkov_version": "unknown"}}' > reports/checkov-results.json
          fi
          
          # SARIF í˜•ì‹ìœ¼ë¡œë„ ìƒì„± (ì˜¤ë¥˜ ë°©ì§€ë¥¼ ìœ„í•´ ë³„ë„ ì²˜ë¦¬)
          echo "ğŸ“Š SARIF ê²°ê³¼ ìƒì„± ì¤‘..."
          if checkov \
            --file results/all-manifests.yaml \
            --framework kubernetes \
            --output sarif \
            --soft-fail \
            --quiet > reports/checkov-results.sarif 2>/dev/null; then
            echo "âœ… SARIF ê²°ê³¼ ìƒì„± ì™„ë£Œ"
          else
            echo "âš ï¸ SARIF ìƒì„± ì‹¤íŒ¨, ê¸°ë³¸ SARIF íŒŒì¼ ìƒì„±"
            # ê¸°ë³¸ SARIF êµ¬ì¡° ìƒì„±
            echo '{"$schema":"https://raw.githubusercontent.com/oasis-tcs/sarif-spec/master/Schemata/sarif-schema-2.1.0.json","version":"2.1.0","runs":[{"tool":{"driver":{"name":"Checkov","version":"3.2.464","informationUri":"https://checkov.io/"}},"results":[]}]}' > reports/checkov-results.sarif
          fi
          
      - name: Analyze security results with OpenAI
        if: always()
        id: openai-analysis
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        run: |
          JSON_FILE="reports/checkov-results.json"
          
          if [ ! -f "$JSON_FILE" ] || [ ! -s "$JSON_FILE" ]; then
            echo "ğŸ“„ JSON ê²°ê³¼ íŒŒì¼ì´ ì—†ê±°ë‚˜ ë¹„ì–´ìˆìŠµë‹ˆë‹¤."
            echo "analysis_result=ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ê±°ë‚˜ ìŠ¤ìº”ì´ ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤." >> $GITHUB_OUTPUT
            echo "issue_count=0" >> $GITHUB_OUTPUT
            exit 0
          fi
          
          echo "ğŸ¤– OpenAIë¥¼ í†µí•œ ë³´ì•ˆ ë¶„ì„ ì‹œì‘..."
          
          # OpenAI API í˜¸ì¶œì„ ìœ„í•œ Python ìŠ¤í¬ë¦½íŠ¸ ìƒì„±
          cat > analyze_security.py << 'EOF'
          import json
          import os
          import sys
          import requests
          
          def analyze_checkov_results(json_file):
              try:
                  with open(json_file, 'r') as f:
                      data = json.load(f)
                  
                  # Checkov ê²°ê³¼ì—ì„œ ì‹¤íŒ¨í•œ ê²€ì‚¬ë“¤ ì¶”ì¶œ
                  failed_checks = data.get('results', {}).get('failed_checks', [])
                  
                  if not failed_checks:
                      return "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼: ë°œê²¬ëœ ë³´ì•ˆ ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤."
                  
                  # ì‹¬ê°ë„ë³„ ë¶„ë¥˜
                  critical_issues = []
                  high_issues = []
                  medium_issues = []
                  low_issues = []
                  
                  for check in failed_checks:
                      severity = check.get('severity')
                      if severity:
                          severity = severity.upper()
                      else:
                          severity = 'UNKNOWN'
                      
                      issue_info = {
                          'check_id': check.get('check_id', 'N/A'),
                          'check_name': check.get('check_name', 'N/A'),
                          'file_path': check.get('file_path', 'N/A'),
                          'resource': check.get('resource', 'N/A'),
                          'description': check.get('description', 'N/A')
                      }
                      
                      if severity == 'CRITICAL':
                          critical_issues.append(issue_info)
                      elif severity == 'HIGH':
                          high_issues.append(issue_info)
                      elif severity == 'MEDIUM':
                          medium_issues.append(issue_info)
                      else:
                          low_issues.append(issue_info)
                  
                  # OpenAI API í˜¸ì¶œ
                  api_key = os.getenv('OPENAI_API_KEY')
                  if not api_key:
                      return generate_basic_report(critical_issues, high_issues, medium_issues, low_issues)
                  
                  prompt = f"""
          ë‹¤ìŒì€ div4u í”„ë¡œì íŠ¸ì˜ Kubernetes ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë³´ì•ˆ ê²€ì‚¬(Checkov) ê²°ê³¼ì…ë‹ˆë‹¤. 
          ê°œë°œíŒ€ì—ê²Œ ì „ë‹¬í•  ë³´ì•ˆ ë³´ê³ ì„œë¥¼ í•œêµ­ì–´ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
          
          Critical ì´ìŠˆ: {len(critical_issues)}ê°œ
          High ì´ìŠˆ: {len(high_issues)}ê°œ  
          Medium ì´ìŠˆ: {len(medium_issues)}ê°œ
          Low ì´ìŠˆ: {len(low_issues)}ê°œ
          
          ìƒì„¸ ì´ìŠˆë“¤:
          {json.dumps({'critical': critical_issues, 'high': high_issues, 'medium': medium_issues, 'low': low_issues}, indent=2, ensure_ascii=False)}
          
          ë‹¤ìŒ í˜•ì‹ìœ¼ë¡œ ë³´ê³ ì„œë¥¼ ì‘ì„±í•´ì£¼ì„¸ìš”:
          1. ì „ì²´ ìš”ì•½ (ë³´ì•ˆ ìƒíƒœ í‰ê°€)
          2. ìš°ì„ ìˆœìœ„ë³„ ì´ìŠˆ ë¶„ì„ (Critical/High ìš°ì„ )
          3. êµ¬ì²´ì ì¸ ìˆ˜ì • ë°©ë²• ë° ê¶Œì¥ì‚¬í•­
          4. div4u í”„ë¡œì íŠ¸ íŠ¹ì„±ì„ ê³ ë ¤í•œ ë³´ì•ˆ ê°•í™” ë°©ì•ˆ
          
          ë³´ê³ ì„œëŠ” ê°œë°œìê°€ ë°”ë¡œ ì‹¤í–‰í•  ìˆ˜ ìˆëŠ” êµ¬ì²´ì ì¸ ë‚´ìš©ìœ¼ë¡œ ì‘ì„±í•´ì£¼ì„¸ìš”.
          """
                  
                  try:
                      response = requests.post(
                          'https://api.openai.com/v1/chat/completions',
                          headers={
                              'Authorization': f'Bearer {api_key}',
                              'Content-Type': 'application/json'
                          },
                          json={
                              'model': 'gpt-4o-mini',
                              'messages': [
                                  {'role': 'system', 'content': 'ë‹¹ì‹ ì€ Kubernetes ë³´ì•ˆ ì „ë¬¸ê°€ì…ë‹ˆë‹¤. div4u í”„ë¡œì íŠ¸ì˜ ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ë¥¼ ë¶„ì„í•˜ì—¬ ê°œë°œíŒ€ì—ê²Œ ëª…í™•í•˜ê³  ì‹¤í–‰ ê°€ëŠ¥í•œ ë³´ê³ ì„œë¥¼ ì œê³µí•©ë‹ˆë‹¤.'},
                                  {'role': 'user', 'content': prompt}
                              ],
                              'max_tokens': 3000,
                              'temperature': 0.3
                          },
                          timeout=30
                      )
                      
                      if response.status_code == 200:
                          result = response.json()
                          return result['choices'][0]['message']['content']
                      else:
                          print(f"OpenAI API ì˜¤ë¥˜: {response.status_code}")
                          return generate_basic_report(critical_issues, high_issues, medium_issues, low_issues)
                          
                  except Exception as e:
                      print(f"OpenAI API í˜¸ì¶œ ì‹¤íŒ¨: {e}")
                      return generate_basic_report(critical_issues, high_issues, medium_issues, low_issues)
                      
              except Exception as e:
                  return f"âŒ ë¶„ì„ ì‹¤íŒ¨: {str(e)}"
          
          def generate_basic_report(critical, high, medium, low):
              total_issues = len(critical) + len(high) + len(medium) + len(low)
              
              report = f"""## ğŸ”’ div4u Kubernetes ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼
          
          ### ğŸ“Š ìš”ì•½
          - **ì´ ì´ìŠˆ**: {total_issues}ê°œ
          - **Critical**: {len(critical)}ê°œ ğŸ”´
          - **High**: {len(high)}ê°œ ğŸŸ   
          - **Medium**: {len(medium)}ê°œ ğŸŸ¡
          - **Low**: {len(low)}ê°œ âšª
          
          ### ğŸš¨ ìš°ì„  ì¡°ì¹˜ í•„ìš” (Critical + High)
          """
              
              priority_issues = critical + high
              if priority_issues:
                  for i, issue in enumerate(priority_issues[:5], 1):
                      report += f"""
          **{i}. {issue['check_name']}**
          - íŒŒì¼: `{issue['file_path']}`
          - ë¦¬ì†ŒìŠ¤: `{issue['resource']}`
          - ì„¤ëª…: {issue['description']}
          """
              else:
                  report += "\nâœ… ìš°ì„  ì¡°ì¹˜ê°€ í•„ìš”í•œ Critical/High ì´ìŠˆê°€ ì—†ìŠµë‹ˆë‹¤."
              
              if len(priority_issues) > 5:
                  report += f"\n\n*ì¶”ê°€ë¡œ {len(priority_issues) - 5}ê°œì˜ ìš°ì„ ìˆœìœ„ ì´ìŠˆê°€ ë” ìˆìŠµë‹ˆë‹¤.*"
              
              report += f"""
          
          ### ğŸ“‹ div4u í”„ë¡œì íŠ¸ ê¶Œì¥ ì¡°ì¹˜ì‚¬í•­
          1. **ì¦‰ì‹œ ìˆ˜ì •**: Critical/High ì´ìŠˆë¥¼ ìš°ì„ ì ìœ¼ë¡œ í•´ê²°
          2. **ë³´ì•ˆ ê°•í™”**: ì»¨í…Œì´ë„ˆ ë³´ì•ˆ ì»¨í…ìŠ¤íŠ¸ ì„¤ì • ê²€í† 
          3. **ë¦¬ì†ŒìŠ¤ ê´€ë¦¬**: CPU/Memory ì œí•œ ë° ìš”ì²­ ì„¤ì •
          4. **ë„¤íŠ¸ì›Œí¬ ë³´ì•ˆ**: NetworkPolicy ë° ì„œë¹„ìŠ¤ ë³´ì•ˆ ê²€í† 
          5. **ì •ê¸° ê²€ì‚¬**: ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë³€ê²½ ì‹œ ìë™ ë³´ì•ˆ ê²€ì‚¬ í™œìš©
          
          ì „ì²´ ìƒì„¸ ê²°ê³¼ëŠ” GitHub Actions ì•„í‹°íŒ©íŠ¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
          """
              
              return report
          
          if __name__ == "__main__":
              if len(sys.argv) != 2:
                  print("Usage: python analyze_security.py <json_file>")
                  sys.exit(1)
              
              result = analyze_checkov_results(sys.argv[1])
              print(result)
          EOF
          
          # Python ìŠ¤í¬ë¦½íŠ¸ ì‹¤í–‰
          python3 analyze_security.py "$JSON_FILE" > analysis_result.txt
          
          # GitHub Outputì— ê²°ê³¼ ì €ì¥ (ë©€í‹°ë¼ì¸ ì²˜ë¦¬)
          echo "analysis_result<<EOF" >> $GITHUB_OUTPUT
          cat analysis_result.txt >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT
          
          # ì´ìŠˆ ê°œìˆ˜ í™•ì¸
          ISSUE_COUNT=$(python3 -c "
          import json
          try:
              with open('$JSON_FILE', 'r') as f:
                  data = json.load(f)
              failed_checks = data.get('results', {}).get('failed_checks', [])
              print(len(failed_checks))
          except:
              print(0)
          ")
          
      - name: Create GitHub Issue for security findings
        if: always() && steps.openai-analysis.outputs.issue_count != '0'
        id: create-issue
        uses: actions/github-script@v7
        env:
          ANALYSIS_RESULT: ${{ steps.openai-analysis.outputs.analysis_result }}
          SCAN_REASON: ${{ needs.detect-changes.outputs.scan_reason }}
        with:
          script: |
            const analysis = process.env.ANALYSIS_RESULT;
            const issueCount = '${{ steps.openai-analysis.outputs.issue_count }}';
            const scanReason = process.env.SCAN_REASON;
            
            console.log(`ğŸ” Issue ìƒì„± ì‹œì‘: div4u k8s ë³´ì•ˆ ê²€ì‚¬ (${issueCount}ê°œ ì´ìŠˆ)`);
            
            if (issueCount && issueCount !== '0') {
              // ì‹¬ê°ë„ë³„ ì´ìŠˆ ê°œìˆ˜ ë¶„ì„
              const fs = require('fs');
              let criticalCount = 0;
              let highCount = 0;
              let mediumCount = 0;
              let lowCount = 0;
              let priorityLabel = 'low';
              
              try {
                const jsonFile = 'reports/checkov-results.json';
                if (fs.existsSync(jsonFile)) {
                  const data = JSON.parse(fs.readFileSync(jsonFile, 'utf8'));
                  const failedChecks = data.results?.failed_checks || [];
                  
                  failedChecks.forEach(check => {
                    const severity = check.severity?.toUpperCase() || 'UNKNOWN';
                    switch(severity) {
                      case 'CRITICAL': criticalCount++; break;
                      case 'HIGH': highCount++; break;
                      case 'MEDIUM': mediumCount++; break;
                      case 'LOW': lowCount++; break;
                    }
                  });
                  
                  // ìš°ì„ ìˆœìœ„ ë¼ë²¨ ê²°ì •
                  if (criticalCount > 0) priorityLabel = 'critical';
                  else if (highCount > 0) priorityLabel = 'high';
                  else if (mediumCount > 0) priorityLabel = 'medium';
                  else priorityLabel = 'low';
                }
              } catch (e) {
                console.log('JSON íŒŒì¼ ì½ê¸° ì‹¤íŒ¨:', e);
              }
              
              // ì‹¬ê°ë„ë³„ ì´ëª¨ì§€ì™€ ê°œìˆ˜ í‘œì‹œ
              const severityBadges = [];
              if (criticalCount > 0) severityBadges.push(`ğŸ”´ Critical: ${criticalCount}`);
              if (highCount > 0) severityBadges.push(`ğŸŸ  High: ${highCount}`);
              if (mediumCount > 0) severityBadges.push(`ğŸŸ¡ Medium: ${mediumCount}`);
              if (lowCount > 0) severityBadges.push(`âšª Low: ${lowCount}`);
              
              const severityDisplay = severityBadges.join(' | ');
              const totalIssues = criticalCount + highCount + mediumCount + lowCount;
              
              // ì œëª© ìƒì„±
              const hasCriticalHigh = criticalCount > 0 || highCount > 0;
              const title = hasCriticalHigh 
                ? `ğŸš¨ [div4u] ê¸´ê¸‰ K8s ë³´ì•ˆ ì´ìŠˆ (ì´ ${totalIssues}ê°œ)`
                : `ğŸ”’ [div4u] K8s ë³´ì•ˆ ê²€í†  í•„ìš” (ì´ ${totalIssues}ê°œ)`;
              
              // ì´ìŠˆ ë³¸ë¬¸ ìƒì„±
              const body = `## ğŸ“Š div4u Kubernetes ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼
            
            **í”„ë¡œì íŠ¸**: div4u  
            **ìŠ¤ìº” ëŒ€ìƒ**: k8s/ ë””ë ‰í„°ë¦¬  
            **ì´ ì´ìŠˆ ê°œìˆ˜**: ${totalIssues}ê°œ  
            **ì‹¤í–‰ ì´ìœ **: ${scanReason}  
            **ë¸Œëœì¹˜**: \`${{ github.ref_name }}\`  
            **ì»¤ë°‹**: \`${{ github.sha }}\`
            
            ### ğŸ¯ ì‹¬ê°ë„ë³„ ë¶„í¬
            ${severityDisplay}
            
            ---
            
            ${analysis}
            
            ## ğŸ“‹ í•´ê²° ì²´í¬ë¦¬ìŠ¤íŠ¸
            ${criticalCount > 0 ? '- [ ] ğŸ”´ **Critical ì´ìŠˆ ì¦‰ì‹œ í•´ê²°** (ë³´ì•ˆ ìœ„í—˜ ë†’ìŒ)' : ''}
            ${highCount > 0 ? '- [ ] ğŸŸ  **High ì´ìŠˆ ìš°ì„  í•´ê²°** (ë³´ì•ˆ ìœ„í—˜ ìˆìŒ)' : ''}
            ${mediumCount > 0 ? '- [ ] ğŸŸ¡ **Medium ì´ìŠˆ ê²€í† ** (ë³´ì•ˆ ê°œì„  í•„ìš”)' : ''}
            ${lowCount > 0 ? '- [ ] âšª **Low ì´ìŠˆ ê²€í† ** (ë³´ì•ˆ ê°•í™” ê¶Œì¥)' : ''}
            - [ ] ğŸ“ k8s ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ìˆ˜ì •ì‚¬í•­ ì ìš©
            - [ ] ğŸ§ª ë¡œì»¬ í™˜ê²½ì—ì„œ í…ŒìŠ¤íŠ¸
            - [ ] ğŸ”„ ì¬ê²€ì‚¬ ìˆ˜í–‰ (PR ìƒì„± ì‹œ ìë™ ì‹¤í–‰)
            - [ ] âœ… ì´ìŠˆ í•´ê²° í™•ì¸
            
            ## ğŸ”— ê´€ë ¨ ë§í¬
            - [ì›Œí¬í”Œë¡œìš° ì‹¤í–‰ ê²°ê³¼](${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }})
            - [div4u k8s ë””ë ‰í„°ë¦¬](https://github.com/${{ github.repository }}/tree/${{ github.ref_name }}/k8s)
            - [Checkov ì •ì±… ê°€ì´ë“œ](https://www.checkov.io/5.Policy%20Index/kubernetes.html)
            
            ## ğŸ’¡ div4u í”„ë¡œì íŠ¸ ë³´ì•ˆ íŒ
            - ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë³€ê²½ ì‹œ ìë™ìœ¼ë¡œ ë³´ì•ˆ ê²€ì‚¬ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤
            - PR ìƒì„± ì‹œì—ë„ ë³´ì•ˆ ê²€ì‚¬ê°€ ìˆ˜í–‰ë˜ì–´ ì½”ë“œ ë¦¬ë·°ì— ë„ì›€ì´ ë©ë‹ˆë‹¤
            - ì •ê¸°ì ìœ¼ë¡œ ë§¤ì¼ ì˜¤ì „ 9ì‹œì— ì „ì²´ ë³´ì•ˆ ê²€ì‚¬ê°€ ì‹¤í–‰ë©ë‹ˆë‹¤
            
            ---
            *ğŸ¤– ìë™ ìƒì„±ëœ ë³´ì•ˆ ì´ìŠˆì…ë‹ˆë‹¤. ëª¨ë“  ì´ìŠˆ í•´ê²° í›„ ì´ Issueë¥¼ ë‹«ì•„ì£¼ì„¸ìš”.*  
            *ğŸ“… ìƒì„± ì‹œê°„: ${new Date().toISOString()}*`;
              
              const labels = ['security', 'k8s', 'checkov', priorityLabel, 'automated'];
              
              try {
                const issue = await github.rest.issues.create({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  title: title,
                  body: body,
                  labels: labels
                });
                
                console.log(`âœ… Issue ìƒì„± ì™„ë£Œ: ${title}`);
                console.log(`ğŸ“Š ì‹¬ê°ë„ ë¶„í¬: ${severityDisplay}`);
                console.log(`ğŸ”— Issue URL: ${issue.data.html_url}`);
                
                core.setOutput('issue_url', issue.data.html_url);
                core.setOutput('issue_number', issue.data.number);
                
              } catch (error) {
                console.error('âŒ Issue ìƒì„± ì‹¤íŒ¨:', error);
                core.setOutput('issue_url', '');
                core.setOutput('issue_number', '');
              }
            }

      - name: Send Slack notification
        if: always()
        env:
          SLACK_WEBHOOK_URL_CHECKOV: ${{ secrets.SLACK_WEBHOOK_URL_CHECKOV }}
          ANALYSIS_RESULT: ${{ steps.openai-analysis.outputs.analysis_result }}
          ISSUE_COUNT: ${{ steps.openai-analysis.outputs.issue_count }}
          SCAN_REASON: ${{ needs.detect-changes.outputs.scan_reason }}
          ISSUE_URL: ${{ steps.create-issue.outputs.issue_url }}
          ISSUE_NUMBER: ${{ steps.create-issue.outputs.issue_number }}
        run: |
          if [ -z "$SLACK_WEBHOOK_URL_CHECKOV" ]; then
            echo "âš ï¸ Slack ì›¹í›… URLì´ ì„¤ì •ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤"
            echo "SLACK_WEBHOOK_URL_CHECKOV secretì„ ì„¤ì •í•˜ë©´ Slack ì•Œë¦¼ì„ ë°›ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤"
            exit 0
          fi
          
          echo "ğŸ“¢ Slack ì•Œë¦¼ ì „ì†¡ ì¤‘..."
          
          # ë³´ì•ˆ ì´ìŠˆ ìœ ë¬´ì— ë”°ë¥¸ ë©”ì‹œì§€ ì„¤ì •
          if [ "$ISSUE_COUNT" != "0" ] && [ -n "$ISSUE_URL" ]; then
            # ë³´ì•ˆ ì´ìŠˆê°€ ìˆëŠ” ê²½ìš°
            MESSAGE_TEXT="div4u K8s ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ\\në³´ì•ˆ ì´ìŠˆ ${ISSUE_COUNT}ê°œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\\nìƒì„¸ ë¶„ì„ ê²°ê³¼ ë° í•´ê²° ê°€ì´ë“œëŠ” ìƒì„±ëœ Issueì—ì„œ í™•ì¸í•˜ì„¸ìš”."
            BUTTON_TEXT="ë³´ì•ˆ ì´ìŠˆ í™•ì¸"
            LINK_URL="$ISSUE_URL"
            HEADER_EMOJI="ğŸš¨"
            COLOR="danger"
          else
            # ë³´ì•ˆ ì´ìŠˆê°€ ì—†ëŠ” ê²½ìš°
            MESSAGE_TEXT="div4u K8s ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ\\në³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\\nëª¨ë“  ë³´ì•ˆ ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤."
            BUTTON_TEXT="ì›Œí¬í”Œë¡œìš° ë³´ê¸°"
            LINK_URL="${{ github.server_url }}/${{ github.repository }}/actions/runs/${{ github.run_id }}"
            HEADER_EMOJI="âœ…"
            COLOR="good"
          fi
          
          python3 << 'EOF'
          import json
          import os
          import urllib.request
          import urllib.parse
          
          # í™˜ê²½ ë³€ìˆ˜ì—ì„œ ê°’ ì½ê¸°
          webhook_url = os.environ.get('SLACK_WEBHOOK_URL_CHECKOV')
          issue_count = os.environ.get('ISSUE_COUNT', '0')
          scan_reason = os.environ.get('SCAN_REASON', 'Unknown')
          issue_url = os.environ.get('ISSUE_URL', '')
          branch_name = os.environ.get('GITHUB_REF_NAME', 'unknown')
          
          # ë³´ì•ˆ ì´ìŠˆ ìœ ë¬´ì— ë”°ë¥¸ ë©”ì‹œì§€ ì„¤ì •
          if issue_count != "0" and issue_url:
              # ë³´ì•ˆ ì´ìŠˆê°€ ìˆëŠ” ê²½ìš°
              header_emoji = "ğŸš¨"
              message_text = f"div4u K8s ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ\\në³´ì•ˆ ì´ìŠˆ {issue_count}ê°œê°€ ë°œê²¬ë˜ì—ˆìŠµë‹ˆë‹¤.\\nìƒì„¸ ë¶„ì„ ê²°ê³¼ ë° í•´ê²° ê°€ì´ë“œëŠ” ìƒì„±ëœ Issueì—ì„œ í™•ì¸í•˜ì„¸ìš”."
              button_text = "ë³´ì•ˆ ì´ìŠˆ í™•ì¸"
              link_url = issue_url
              color = "danger"
          else:
              # ë³´ì•ˆ ì´ìŠˆê°€ ì—†ëŠ” ê²½ìš°
              header_emoji = "âœ…"
              message_text = "div4u K8s ë³´ì•ˆ ê²€ì‚¬ ì™„ë£Œ\\në³´ì•ˆ ì´ìŠˆê°€ ë°œê²¬ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.\\nëª¨ë“  ë³´ì•ˆ ê²€ì‚¬ë¥¼ í†µê³¼í–ˆìŠµë‹ˆë‹¤."
              button_text = "ì›Œí¬í”Œë¡œìš° ë³´ê¸°"
              link_url = f"{os.environ.get('GITHUB_SERVER_URL', 'https://github.com')}/{os.environ.get('GITHUB_REPOSITORY', '')}/actions/runs/{os.environ.get('GITHUB_RUN_ID', '')}"
              color = "good"
          
          # Slack ë©”ì‹œì§€ êµ¬ì¡° ìƒì„± (ê°„ë‹¨í•œ í˜•ì‹ìœ¼ë¡œ HTTP 400 ì˜¤ë¥˜ ë°©ì§€)
          slack_message = {
              "text": f"{header_emoji} div4u K8s ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼",
              "attachments": [
                  {
                      "color": color,
                      "fields": [
                          {
                              "title": "í”„ë¡œì íŠ¸",
                              "value": "div4u",
                              "short": True
                          },
                          {
                              "title": "ë°œê²¬ëœ ì´ìŠˆ",
                              "value": f"{issue_count}ê°œ",
                              "short": True
                          },
                          {
                              "title": "ì‹¤í–‰ ì´ìœ ",
                              "value": scan_reason,
                              "short": True
                          },
                          {
                              "title": "ë¸Œëœì¹˜",
                              "value": branch_name,
                              "short": True
                          }
                      ],
                      "text": message_text.replace('\\n', '\n'),
                      "actions": [
                          {
                              "type": "button",
                              "text": button_text,
                              "url": link_url,
                              "style": "primary" if color == "good" else "danger"
                          }
                      ]
                  }
              ]
          }
          
          # Slack ì›¹í›…ìœ¼ë¡œ ì „ì†¡
          try:
              data = json.dumps(slack_message, ensure_ascii=False).encode('utf-8')
              req = urllib.request.Request(
                  webhook_url,
                  data=data,
                  headers={
                      'Content-Type': 'application/json; charset=utf-8',
                      'User-Agent': 'div4u-security-scan/1.0'
                  }
              )
              
              with urllib.request.urlopen(req, timeout=10) as response:
                  response_text = response.read().decode('utf-8')
                  if response.status == 200:
                      print("âœ… Slack ì•Œë¦¼ ì „ì†¡ ì™„ë£Œ")
                      if issue_count != "0" and issue_url:
                          print(f"ğŸ”— Issue ë§í¬: {issue_url}")
                      else:
                          print("âœ… ë³´ì•ˆ ì´ìŠˆ ì—†ìŒ")
                  else:
                      print(f"âŒ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: HTTP {response.status}")
                      print(f"ì‘ë‹µ: {response_text}")
                      
          except urllib.error.HTTPError as e:
              error_body = e.read().decode('utf-8') if e.fp else 'No error body'
              print(f"âŒ Slack HTTP ì˜¤ë¥˜: {e.code} {e.reason}")
              print(f"ì˜¤ë¥˜ ë‚´ìš©: {error_body}")
              # ë©”ì‹œì§€ ë‚´ìš© ë””ë²„ê¹…
              print(f"ì „ì†¡í•œ ë©”ì‹œì§€ í¬ê¸°: {len(data)} bytes")
          except Exception as e:
              print(f"âŒ Slack ì•Œë¦¼ ì „ì†¡ ì‹¤íŒ¨: {e}")
          EOF
      - name: Upload SARIF to GitHub Security
        if: always() && (github.event_name != 'pull_request' || (github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false))
        uses: github/codeql-action/upload-sarif@v3
        with:
          sarif_file: reports/checkov-results.sarif
          category: checkov-k8s
        continue-on-error: true

      - name: Upload scan results as artifacts
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: div4u-k8s-security-scan-results-${{ github.sha }}
          path: |
            reports/
            results/
          if-no-files-found: warn
          retention-days: 30

  # ë³€ê²½ì‚¬í•­ì´ ì—†ì„ ë•Œ ë¹ ë¥¸ ì¢…ë£Œ
  no-changes:
    needs: detect-changes
    if: needs.detect-changes.outputs.should_scan == 'false'
    runs-on: ubuntu-latest
    steps:
      - name: No changes detected
        run: |
          echo "âœ… k8s ë””ë ‰í„°ë¦¬ì— ë³€ê²½ì‚¬í•­ì´ ì—†ìŠµë‹ˆë‹¤."
          echo "ğŸ“ ëª¨ë‹ˆí„°ë§ëœ ë””ë ‰í„°ë¦¬: k8s/"
          echo "ğŸ”§ ì›Œí¬í”Œë¡œ íŒŒì¼: .github/workflows/k8s-security-scan.yaml"
          echo ""
          echo "ë³€ê²½ì‚¬í•­ì´ ê°ì§€ë˜ë©´ ìë™ìœ¼ë¡œ ë³´ì•ˆ ìŠ¤ìº”ì´ ì‹¤í–‰ë©ë‹ˆë‹¤."
          echo "::notice::ë³€ê²½ì‚¬í•­ ì—†ìŒ - ë³´ì•ˆ ìŠ¤ìº”ì„ ê±´ë„ˆëœë‹ˆë‹¤."

  # ìŠ¤ìº” ì™„ë£Œ ìš”ì•½
  summary:
    needs: [detect-changes, security-scan]
    if: always()
    runs-on: ubuntu-latest
    steps:
      - name: Security scan summary
        run: |
          echo "## ğŸ”’ div4u Kubernetes ë³´ì•ˆ ìŠ¤ìº” ì™„ë£Œ"
          echo ""
          echo "**í”„ë¡œì íŠ¸**: div4u"
          echo "**ìŠ¤ìº” ëŒ€ìƒ**: k8s/ ë””ë ‰í„°ë¦¬"
          echo "**ì‹¤í–‰ ì´ìœ **: ${{ needs.detect-changes.outputs.scan_reason }}"
          echo "**ë¸Œëœì¹˜**: ${{ github.ref_name }}"
          echo "**ì»¤ë°‹**: ${{ github.sha }}"
          echo ""
          
          if [ "${{ needs.detect-changes.outputs.should_scan }}" = "true" ]; then
            echo "**ìŠ¤ìº” ê²°ê³¼**: ${{ needs.security-scan.result }}"
            echo "**ì‹¤í–‰ ì‹œê°„**: $(date '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "ìƒì„¸ ê²°ê³¼ëŠ” ì•„í‹°íŒ©íŠ¸ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤."
          else
            echo "**ìŠ¤ìº” ìƒíƒœ**: ê±´ë„ˆëœ€ (ë³€ê²½ì‚¬í•­ ì—†ìŒ)"
          fi
          
          echo ""
          echo "### ğŸ“‹ div4u ë³´ì•ˆ ê²€ì‚¬ ì •ë³´"
          echo "- **ìë™ íŠ¸ë¦¬ê±°**: main/develop ë¸Œëœì¹˜ì˜ k8s/ ë””ë ‰í„°ë¦¬ ë³€ê²½ ì‹œ"
          echo "- **PR ê²€ì‚¬**: Pull Request ìƒì„± ì‹œ ìë™ ì‹¤í–‰"
          echo "- **ì •ê¸° ê²€ì‚¬**: ë§¤ì¼ ì˜¤ì „ 9ì‹œ UTC (í•œêµ­ì‹œê°„ ì˜¤í›„ 6ì‹œ)"
          echo "- **ìˆ˜ë™ ì‹¤í–‰**: Actions íƒ­ì—ì„œ 'Run workflow' ë²„íŠ¼ìœ¼ë¡œ ì‹¤í–‰ ê°€ëŠ¥"
